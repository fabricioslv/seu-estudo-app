indexjsPontodeentradaparaoservidorbackendconstpath=requirepath;requiredotenvconfigpath:pathresolvedirnameenv;Carregaasvariveisdeambientedeformaexplcitaconstexpress=requireexpress;LOGDIAGNSTICO:VerificandoinciodoservidorconsolelogDIAGNSTICO:IniciandoservidorSeuEstudo;consolelogDIAGNSTICO:NODEENV=processenvNODEENV;consolelogDIAGNSTICO:Porta=processenvPORT2000;consolelogDIAGNSTICO:DatabaseURLconfigurada=processenvDATABASEURL;consolelogDIAGNSTICO:JWTSECRETconfigurado=processenvJWTSECRET;consolelogDIAGNSTICO:FRONTENDURL=processenvFRONTENDURL;consolelogDIAGNSTICO:Todasasvariveisdeambientecarregadas;consthttp=requirehttp;consthelmet=requirehelmet;constServer=requiresocketio;ImportasistemasdelogsetratamentodeerrosimportloggersystemLoggerhttpLoggerMiddlewareperformanceMiddlewarefromservicesloggerjs;importerrorHandlernotFoundHandlerasyncErrorHandlersecurityMonitorfrommiddlewareerrorHandlermjs;importsecurityMonitoringMiddlewarefromservicessecurityLoggerjs;importperformanceMonitoringMiddlewareSystemMetricsfromservicesperformanceLoggerjs;importbusinessActivityMiddlewarebusinessLoggerfromservicesbusinessLoggerjs;importcorsfromcors;constapp=express;constserver=httpcreateServerapp;ConfiguraoCORSsegurabaseadanoambienteconstcorsOptions=origin:functionorigincallbackEmproduopermitaapenasdomniosespecficosconstallowedOrigins=processenvNODEENV===production?[https:seuestudovercelapphttps:wwwseuestudocomprocessenvFRONTENDURLfilterBoolean:[http:localhost:3000http:127001:3000http:localhost:3001http:127001:3001;Permiterequisiessemorigincomoappsmobileiforiginreturncallbacknulltrue;ifallowedOriginsindexOforigin==1callbacknulltrue;elsecallbacknewErrorNopermitidopeloCORS;credentials:truemethods:[GETPOSTPUTDELETEOPTIONSallowedHeaders:[ContentTypeAuthorizationxcsrftokenexposedHeaders:[xcsrftoken;ConfiguraoSocketIOcomCORSseguroconstio=newServerservercors:corsOptions;constPORT=processenvPORT2000;InicializasistemasdemonitoramentoconstsystemMetrics=newSystemMetrics;systemMetricsstartMonitoring;InicializaserviodehealthchecksavanadoimportHealthCheckServicefromserviceshealthCheckServicejs;InicializavariveisglobaispararastreadoresglobalbusinessActivityTracker=null;globalbusinessEventTracker=null;LogsdeinicializaodosistemasystemLoggerInicializandoservidorSeuEstudonodeVersion:processversionplatform:processplatformenvironment:processenvNODEENVdevelopmentport:PORTtimestamp:newDatetoISOString;MiddlewaresdeseguranaappusehelmetcontentSecurityPolicy:directives:defaultSrc:[selfstyleSrc:[selfunsafeinlinehttps:fontsgoogleapiscomfontSrc:[selfhttps:fontsgstaticcomscriptSrc:[selfimgSrc:[selfdata:https:connectSrc:[selfcrossOriginEmbedderPolicy:falsePermiterecursosexternossenecessrio;MiddlewareCORSseguroappusecorscorsOptions;MiddlewaresdeloggingemonitoramentoappusehttpLoggerMiddleware;appuseperformanceMiddleware;appusesecurityMonitoringMiddleware;appuseperformanceMonitoringMiddleware;appusebusinessActivityMiddleware;RatelimitinggeralimportgeneralRateLimitfrommiddlewarerateLimitermjs;appuseapigeneralRateLimit;MonitoramentodeseguranaadicionalappuseapisecurityMonitor;Middlewareparaparsingdedadosappuseexpressjsonlimit:10mb;appuseexpressurlencodedextended:truelimit:10mb;Rotaspblicasappgetreqres=>systemLoggerAcessopginainicialip:reqipuserAgent:reqgetUserAgent;ressendServidordoSeuEstudoestnoar;;DefineasrotasdaAPIcomtratamentodeerrosautomticotryappuseapiauthrequireroutesauth;appuseapiquestoesasyncErrorHandlerrequireroutesquestoestemp;appuseapiasyncErrorHandlerrequirerouteshealth;RotasdehealthcheckparamonitoramentoappuseapiprofessoresasyncErrorHandlerrequireroutesprofessores;appuseapiprofessorsimuladosasyncErrorHandlerrequireroutesprofessorSimulados;appuseapigamificacaoasyncErrorHandlerrequireroutesgamificacao;NovarotadegamificaoappuseapisimuladosasyncErrorHandlerrequireroutessimulados;RotasparasimuladosdeestudantesappuseapimensagensasyncErrorHandlerrequireroutesmensagens;RotasparaosistemademensagensappuseapinotificacoesasyncErrorHandlerrequireroutesnotificacoes;RotasparaosistemadenotificaesappuseapinotasasyncErrorHandlerrequireroutesnotas;RotasparaosistemadenotasappuseapitutoriaasyncErrorHandlerrequireroutestutoria;RotasparaosistemadetutoriasystemLoggerRotasdaAPIregistradascomsucesso;catcherrorsystemLoggerErroaoregistrarrotasdaAPIerror:errormessage;throwerror;MiddlewareparatratamentoderotasnoencontradasappusenotFoundHandler;LgicadoWebSocketparaochatcomlogsestruturadosioonconnectionsocket=>systemLoggerNovaconexoWebSocketestabelecidasocketId:socketidip:sockethandshakeaddressuserAgent:sockethandshakeheaders[useragent;socketonjoinroomroom=>socketjoinroom;businessLoggerUsurioentrouemsaladechatsocketId:socketidroomtimestamp:newDatetoISOString;;socketonsendmessagedata=>Emiteamensagemparatodosnasalaincluindooremetenteiotodataroomemitreceivemessagedata;businessLoggerMensagemenviadanochatsocketId:socketidroom:dataroommessageLength:datamessage?datamessagelength:0timestamp:newDatetoISOString;;socketondisconnect=>systemLoggerConexoWebSocketdesconectadasocketId:socketidtimestamp:newDatetoISOString;;;TratamentodeerrosglobalappuseerrorHandler;InicializaodoservidorcomlogsdetalhadosconststartServer=async=>tryserverlistenPORT=>systemLoggerServidoriniciadocomsucessoport:PORTenvironment:processenvNODEENVdevelopmentuptime:processuptimememoryUsage:processmemoryUsagetimestamp:newDatetoISOString;loggerinfoServidorSeuEstudorodandonaportaPORT;;TratamentodesinaisdeinterrupoprocessonSIGTERMgracefulShutdown;processonSIGINTgracefulShutdown;TratamentodeerrosnocapturadosprocessonuncaughtExceptionerror=>systemLoggerErronocapturadodetectadoerror:errormessagestack:errorstacktimestamp:newDatetoISOString;processexit1;;processonunhandledRejectionreasonpromise=>systemLoggerPromessarejeitadanotratadareason:reasontoStringtimestamp:newDatetoISOString;;catcherrorsystemLoggerErroaoiniciarservidorerror:errormessagestack:errorstack;processexit1;;FunoparadesligamentograciosoconstgracefulShutdown==>systemLoggerIniciandodesligamentograciosodoservidortimestamp:newDatetoISOString;serverclose=>systemLoggerServidorHTTPfechado;ParamonitoramentodemtricassystemMetricsstopMonitoring;ParaserviodehealthchecksifglobalhealthCheckServiceglobalhealthCheckServicestopMonitoring;systemLoggerDesligamentograciosoconcludo;processexit0;;Foraofechamentoaps10segundossetTimeout=>systemLoggerForandofechamentodoservidortimeout;processexit1;10000;;IniciaoservidorstartServer;
